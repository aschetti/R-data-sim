---
title: "Simulate data in R with package `faux`"
author: '[Antonio Schettino](https://osf.io/zbv65/ "Antonio Schettino")'
date: '`r Sys.Date()`'
output:
  html_document:
    theme: united
    highlight: tango
    code_folding: show
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r doc-setup, include = FALSE}

seed_smorfia <- 17 # 'A disgrazia!
set.seed(seed_smorfia) # seed for random number generation

# ### install packages
# install.packages("here")
# install.packages("knitr")
# install.packages("kableExtra")
# install.packages("tidyverse")
# install.packages("faux")
# install.packages("rstatix")
# install.packages("lme4")
# install.packages("broom.mixed")
# install.packages("ggpubr")

### load packages
library(here)
library(knitr)
library(kableExtra)
library(tidyverse)
library(faux)
library(rstatix)
library(lme4)
library(broom.mixed)
library(ggpubr)

# for RMarkdown
# options(digits = 2) # number of decimal digits
opts_chunk$set(
  echo = TRUE, # show code
  warning = FALSE, # no package warnings
  message = FALSE, # no package messages
  fig.dim = c(8, 8) # figure width & height
)

# ggplot custom theme
theme_custom <-
  theme_pubr(base_size = 16) +
  theme(
    strip.text = element_text(
      hjust = .5,
      size = 20
    ),
    plot.title = element_text(size = 26, hjust = .5),
    legend.box.background = element_rect(color = "transparent"),
    legend.position = "none"
  )

```

***
***

# Why simulate data?

Here are some reasons[^1]:

- analyze your experimental design
  - number of groups?
  - number of participants?
  - number of conditions?
  - number of trials for each condition?
- evaluate your statistical procedures
  - what are the distributional properties of the data?
  - are model assumptions appropriate?
- power analysis
  - what effect size is your experimental design sensitive to?
  - how does sensitivity change as a function of the number of participants and/or trials?
- plan data management
  - size and type of data and model files
  - folder structure
- practical feasibility
  - is there enough information in the literature to simulate plausible scenarios?
  - is your statistical model computationally feasible?
  - if the results of the power analysis require a large number of participants and/or trials, do you have enough time and/or resources?

# How to simulate data in R

There are many ways to simulate data in R. The easiest way is to use base R functions. Here we use `rnorm` to generate 1000 random samples from a normal distribution with mean = 0 and standard deviation = 1:

```{r rnorm-data}

rnorm_data <- rnorm(1000, mean = 0, sd = 1)

# show first 10 samples
head(rnorm_data, 10) 

```

```{r rnorm-plot}

rnorm_data %>%
  as_tibble() %>%
  ggplot(aes(x = value)) +
    geom_histogram(
    bins = 50,
    color = "black",
    fill = "#00AFBB"
  ) +
  ggtitle("Normal distribution") +
  theme_custom

```

Other functions allow you to sample from different distributions, e.g., uniform (`runif`), binomial (`rbinom`), Student's t (`rt`), and more (for a complete list, type `?distributions` in the console).

However, in this workshop we will be using the package `faux`, created by [Prof. Lisa DeBruine](https://www.gla.ac.uk/researchinstitutes/neurosciencepsychology/staff/lisadebruine/). 




**WHY?**






# One-sample t-test

## Data Simulation

```{r ttest-onesample-data}

# parameters
ttest_onesample_between <- list(condition = c("test")) # list of between-subject factors
ttest_onesample_n <- 50 # number of participants
ttest_onesample_mu_cond <- 1 # means
ttest_onesample_sd_cond <- 1 # standard deviations

# data simulation
ttest_onesample_data <-
  sim_design(
    between = ttest_onesample_between,
    n = ttest_onesample_n,
    mu = ttest_onesample_mu_cond,
    sd = ttest_onesample_sd_cond,
    empirical = FALSE, # exact mean/SD?
    long = TRUE, # results in long format
    dv = list(value = "value"), # name of dependent variables
    id = list(id = "id"), # name of ID column
    plot = FALSE, # plot?
    rep = 1 # number of simulated datasets
  ) %>%
  as_tibble()

# save as .csv
write_csv(
  ttest_onesample_data,
  here("data/ttest_onesample_data.csv")
)

# show first 10 rows
ttest_onesample_data %>%
  head(n = 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Statistical Analysis

```{r ttest-onesample-test}

ttest_onesample_results <-
  t_test(
    data = ttest_onesample_data, # data
    formula = value ~ 1, # formula
    p.adjust.method = "holm", # p-value adjustment
    paired = FALSE, # paired test?
    var.equal = FALSE, # assume equal variance?
    alternative = "two.sided", # alternative hypothesis (two-sided, larger than mu, smaller than mu)
    mu = 0, # null value
    conf.level = .95, # width confidence intervals
    detailed = FALSE
  )

ttest_onesample_results %>%
  kable(digits = 12) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Graph

```{r ttest-onesample-plot}

ttest_onesample_plot <-
  ttest_onesample_data %>%
  plot_design(geoms = c("box", "violin", "jitter")) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#440154FF", size = 1.2) +
  ggtitle("One-sample t-test") +
  theme_custom

ggsave( # save to file
  filename = "ttest_onesample_plot.png",
  plot = ttest_onesample_plot,
  device = "png",
  path = here("figures"),
  width = 8,
  height = 8,
  units = "in",
  dpi = 300
)

ttest_onesample_plot

```

# Between-subject t-test

## Data Simulation

```{r ttest-between-data}

# parameters
ttest_between_between <- list(treatment = c("control", "drug"))
ttest_between_n <- list(control = 50, drug = 40)
ttest_between_mu_cond <- list(control = 1, drug = 2)
ttest_between_sd_cond <- list(control = 1, drug = 1.4)

# data simulation
ttest_between_data <-
  sim_design(
    between = ttest_between_between,
    n = ttest_between_n,
    mu = ttest_between_mu_cond,
    sd = ttest_between_sd_cond,
    empirical = FALSE,
    long = TRUE,
    dv = list(value = "value"),
    id = list(id = "id"),
    plot = FALSE,
    rep = 1
  ) %>%
  as_tibble()

# save as .csv
write_csv(
  ttest_between_data,
  here("data/ttest_between_data.csv")
)

# show first 10 rows
ttest_between_data %>%
  head(n = 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Statistical Analysis

```{r ttest-between-test}

ttest_between_results <-
  t_test(
    data = ttest_between_data,
    formula = value ~ treatment,
    p.adjust.method = "holm",
    paired = FALSE,
    var.equal = FALSE,
    alternative = "two.sided",
    mu = 0,
    conf.level = .95,
    detailed = FALSE
  )

ttest_between_results %>%
  kable(digits = 12) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Graph

```{r ttest-between-plot}

ttest_between_plot <-
  ttest_between_data %>%
  plot_design(geoms = c("box", "violin", "jitter")) +
  ggtitle("Between-subject t-test") +
  theme_custom

ggsave(
  filename = "ttest_between_plot.png",
  plot = ttest_between_plot,
  device = "png",
  path = here("figures"),
  width = 8,
  height = 8,
  units = "in",
  dpi = 300
)

ttest_between_plot

```

# Within-subject t-test

## Data Simulation

```{r ttest-within-data}

# parameters
ttest_within_within <- list(condition = c("neutral", "emotion")) # list of within-subject factors
ttest_within_n <- list(neutral = 50, emotion = 50) # number of participants must be the same for each condition
ttest_within_mu_cond <- list(neutral = 1.3, emotion = 2.1)
ttest_within_sd_cond <- list(neutral = 1.2, emotion = 1.6)
ttest_within_r <- .7 # correlations among variables

# data simulation
ttest_within_data <-
  sim_design(
    within = list(condition = c("neutral", "emotion")),
    n = ttest_within_n,
    mu = ttest_within_mu_cond,
    sd = ttest_within_sd_cond,
    r = ttest_within_r,
    empirical = FALSE,
    long = TRUE,
    dv = list(value = "value"),
    id = list(id = "id"),
    plot = FALSE,
    rep = 1
  ) %>%
  as_tibble()

# save as .csv
write_csv(
  ttest_within_data,
  here("data/ttest_within_data.csv")
)

# show first 10 rows
ttest_within_data %>%
  head(n = 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Statistical Analysis

```{r ttest-within-test}

ttest_within_results <-
  t_test(
    data = ttest_within_data,
    formula = value ~ condition,
    p.adjust.method = "holm",
    paired = TRUE,
    var.equal = FALSE,
    alternative = "two.sided",
    mu = 0,
    conf.level = .95,
    detailed = FALSE
  )

ttest_within_results %>%
  kable(digits = 12) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Graph

```{r ttest-within-plot}

ttest_within_plot <-
  ttest_within_data %>%
  plot_design(geoms = c("box", "violin", "jitter")) +
  ggtitle("Within-subject t-test") +
  theme_custom

ggsave(
  filename = "ttest_within_plot.png",
  plot = ttest_within_plot,
  device = "png",
  path = here("figures"),
  width = 8,
  height = 8,
  units = "in",
  dpi = 300
)

ttest_within_plot

```

# 2 x 3 mixed ANOVA

## Data Simulation

```{r ANOVA-data}

# parameters
ANOVA_within <- list(condition = c("neutral", "unpleasant", "pleasant"))
ANOVA_between <- list(treatment = c("control", "drug"))
ANOVA_n <- list(
  control = c(neutral = 50, unpleasant = 50, pleasant = 50), # number of participants must be the same for each condition...
  drug = c(neutral = 30, unpleasant = 30, pleasant = 30) # ... but can be different between groups
)
ANOVA_mu_cond <- list(
  control = c(neutral = 1, unpleasant = 1.5, pleasant = 1.4),
  drug = c(neutral = 1.1, unpleasant = 1.4, pleasant = 2.1)
)
ANOVA_sd_cond <- list(
  control = c(neutral = 1, unpleasant = 1.2, pleasant = 1.2),
  drug = c(neutral = 1.2, unpleasant = 1.5, pleasant = 1.6)
)

ANOVA_r <- list( # if the design has more than 2 within-subject conditions, specify each correlation in the upper right triangle of the correlation matrix as a vector (https://debruine.github.io/faux/articles/sim_design.html#correlations-1)
  control = c(
    .40, .50,
    .60
  ),
  drug = c(
    .15, .25,
    .45
  )
)

# data simulation
ANOVA_data <-
  sim_design(
    within = ANOVA_within,
    between = ANOVA_between,
    n = ANOVA_n,
    mu = ANOVA_mu_cond,
    sd = ANOVA_sd_cond,
    r = ANOVA_r,
    empirical = FALSE,
    long = TRUE,
    dv = list(value = "value"),
    id = list(id = "id"),
    plot = FALSE,
    rep = 1
  ) %>%
  as_tibble()

# save as .csv
write_csv(
  ANOVA_data,
  here("data/ANOVA_data.csv")
)

# show first 10 rows
ANOVA_data %>%
  head(n = 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Statistical Analysis

```{r ANOVA-test}

ANOVA_results <-
  anova_test(
    data = ANOVA_data,
    dv = value,
    wid = id,
    between = "treatment",
    within = "condition",
    type = 2,
    effect.size = "ges",
    detailed = FALSE
  ) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "holm")

ANOVA_results

# treatment, main effect
ANOVA_main_treatment <-
  ANOVA_data %>%
  group_by(condition) %>%
  anova_test(
    dv = value,
    wid = id,
    between = treatment
  ) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "holm")

ANOVA_main_treatment

# treatment, pairwise comparisons
ANOVA_pairwise_treatment <-
  ANOVA_data %>%
  group_by(condition) %>%
  t_test(
    formula = value ~ treatment,
    p.adjust.method = "holm",
    paired = FALSE,
    var.equal = FALSE,
    alternative = "two.sided",
    mu = 0,
    conf.level = 0.95
  )

ANOVA_pairwise_treatment

# condition, main effect
ANOVA_main_condition <-
  ANOVA_data %>%
  group_by(treatment) %>%
  anova_test(
    dv = value,
    wid = id,
    within = condition
  ) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "holm")

ANOVA_main_condition

# condition, pairwise comparisons
ANOVA_pairwise_condition <-
  ANOVA_data %>%
  group_by(treatment) %>%
  t_test(
    formula = value ~ condition,
    p.adjust.method = "holm",
    paired = TRUE,
    var.equal = FALSE,
    alternative = "two.sided",
    mu = 0,
    conf.level = 0.95
  )

ANOVA_pairwise_condition

```

## Graph

```{r ANOVA-plot}

ANOVA_plot <-
  ANOVA_data %>%
  plot_design(geoms = c("box", "violin", "jitter")) +
  ggtitle("Mixed ANOVA") +
  theme_custom +
  theme(legend.position = "right")

ggsave(
  filename = "ANOVA_plot.png",
  plot = ANOVA_plot,
  device = "png",
  path = here("figures"),
  width = 8,
  height = 8,
  units = "in",
  dpi = 300
)

ANOVA_plot

```

# Multilevel Model

## Data Simulation

From https://debruine.github.io/lmem_sim/articles/appendix1a_example_code.html

```{r MLM-params}

# parameters
MLM_n_ssj <- 50 # number of participants
# condition labels
MLM_cat_cond1 <- "ingroup"
MLM_cat_cond2 <- "outgroup"
# number of items for each condition
MLM_n_trials_cond1 <- 25
MLM_n_trials_cond2 <- 25
MLM_mu_grand <- 800 # grand mean [beta_0]
MLM_cond_beta <- 50 # effect of condition [beta_1]
MLM_item_sd <- 80 # by-item random intercept sd [omega_0]
MLM_ssj_sd <- 100 # by-subject random intercept sd [tau_0]
MLM_ssjslope_sd <- 40 # by-subject random slope sd [tau_1]
MLM_cor_int_slope <- .2 # correlation between intercept and slope [rho]
MLM_error_sd <- 200 # residual (standard deviation) [sigma]

```


```{r MLM-data-fun}

# custom data simulation function
MLM_data_fun <- function(
                         n_subj = MLM_n_ssj, # number of subjects
                         label_cond1 = MLM_cat_cond1, # label condition 1
                         label_cond2 = MLM_cat_cond2, # label condition 2
                         n_cond1 = MLM_n_trials_cond1, # number of stimuli condition 1
                         n_cond2 = MLM_n_trials_cond2, # number of stimuli condition 2
                         beta_0 = MLM_mu_grand, # grand mean
                         beta_1 = MLM_cond_beta, # effect of category
                         omega_0 = MLM_item_sd, # by-item random intercept sd
                         tau_0 = MLM_ssj_sd, # by-subject random intercept sd
                         tau_1 = MLM_ssjslope_sd, # by-subject random slope sd
                         rho = MLM_cor_int_slope, # correlation between intercept and slope
                         sigma = MLM_error_sd) { # residual (standard deviation)

  # simulate a sample of items
  items <- data.frame(
    item_id = seq_len(n_cond1 + n_cond2),
    condition = rep(c(label_cond1, label_cond2), c(n_cond1, n_cond2)),
    X_i = rep(c(-0.5, 0.5), c(n_cond1, n_cond2)),
    O_0i = rnorm(n = n_cond1 + n_cond2, mean = 0, sd = omega_0)
  )

  # simulate a sample of subjects
  subjects <- faux::rnorm_multi(
    n = n_subj, mu = 0, sd = c(tau_0, tau_1), r = rho,
    varnames = c("T_0s", "T_1s")
  )
  subjects$subj_id <- 1:n_subj

  # cross subject and item IDs
  crossing(subjects, items) %>%
    mutate(
      e_si = rnorm(nrow(.), mean = 0, sd = sigma),
      value = beta_0 + T_0s + O_0i + (beta_1 + T_1s) * X_i + e_si
    ) %>%
    select(subj_id, item_id, condition, X_i, value) %>%
    arrange(subj_id)
}

```

```{r MLM-data}

MLM_data <- MLM_data_fun()

# save as .csv
write_csv(
  MLM_data,
  here("data/MLM_data.csv")
)

# show first 10 rows
MLM_data %>%
  head(n = 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Statistical Analysis

```{r MLM-test}

# fit a linear mixed-effects model to data
MLM_results <- lmer(value ~ 1 + X_i + (1 | item_id) + (1 + X_i | subj_id),
  data = MLM_data
)

tibble(
  variable = c(
    "beta_0",
    "beta_1",
    "tau_0",
    "rho",
    "tau_1",
    "omega_0",
    "sigma"
  ),
  explanation = c(
    "intercept (grand mean)",
    "fixed effect of category",
    "by-item random intercept SD",
    "by-subject random intercept SD",
    "correlation between intercept and slope",
    "by-subject random slope SD",
    "residual (error) SD"
  ),
  `simulated value` = c(
    MLM_mu_grand,
    MLM_cond_beta,
    MLM_item_sd,
    MLM_ssj_sd,
    MLM_cor_int_slope,
    MLM_ssjslope_sd,
    MLM_error_sd
  ),
  `estimated by model` = broom.mixed::tidy(MLM_results)$estimate
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## Graph

```{r MLM-plot}

MLM_plot <-
  ggviolin(
    MLM_data, # data
    x = "condition", # independent variable
    y = "value", # dependent variable
    color = "condition", # density: line color
    size = 1, # density: line width
    fill = "condition", # density: fill color
    alpha = .5, # density: fill color transparency
    linetype = "solid", # density: line type
    palette = c("#00AFBB", "#E7B800"), # density: color palette
    trim = TRUE, # density: trim tails
    width = 1, # density: violin width
    add = c("boxplot", "jitter"), # overlay boxplot and jittered individual data points
    add.params = list(
      color = "black", # boxplot and jittered points: color
      fill = "white",# boxplot and jittered points: fill color
      alpha = .2# boxplot and jittered points: fill transparency
    ),
    title = "Multilevel Model", # plot title
    label.rectangle = TRUE, # rectangle underneath text
    ggtheme = theme_custom # ggplot theme
  )

ggsave(
  filename = "MLM_plot.png",
  plot = MLM_plot,
  device = "png",
  path = here("figures"),
  width = 8,
  height = 8,
  units = "in",
  dpi = 300
)

MLM_plot

```

***
***

[^1]: Adapted from the book [**Answering questions with data**](https://crumplab.github.io/statistics/index.html) (Chapter [11](https://crumplab.github.io/statistics/simulating-data.html#reasons-to-simulate)) by Matthew J. C. Crump.
