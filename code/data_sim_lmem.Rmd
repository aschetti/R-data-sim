---
title: "Simulate data with crossed random factors in R with package `faux`"
author: '[Antonio Schettino](https://osf.io/zbv65/ "Antonio Schettino")'
date: '`r Sys.Date()`'
output:
  html_document:
    theme: united
    highlight: tango
    code_folding: show
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r doc-setup, include = FALSE}

seed_smorfia <- 17 # 'A disgrazia!
set.seed(seed_smorfia) # set RNG seed

# ### install packages
# install.packages("here")
# install.packages("knitr")
# install.packages("kableExtra")
# install.packages("tidyverse")
# install.packages("faux")
# install.packages("lme4")
# install.packages("broom.mixed")
# install.packages("ggpubr")

### load packages
library(here)
library(knitr)
library(kableExtra)
library(tidyverse)
library(faux)
library(lme4)
library(broom.mixed)
library(ggpubr)

# for RMarkdown
# options(digits = 2) # number of decimal digits
opts_chunk$set(
  echo = TRUE, # show code
  warning = FALSE, # no package warnings
  message = FALSE, # no package messages
  fig.dim = c(8, 8) # figure width & height
)

```

***
***

# Why simulate data?

Here are some reasons[^1]:

- analyze your experimental design
  - number of groups?
  - number of participants?
  - number of conditions?
  - number of trials for each condition?
- evaluate your statistical procedures
  - what are the distributional properties of the data?
  - are model assumptions appropriate?
- power analysis
  - what effect size is your experimental design sensitive to?
  - how does sensitivity change as a function of the number of participants and/or trials?
- plan data management
  - size and type of data and model files
  - folder structure
- practical feasibility
  - is there enough information in the literature to simulate plausible scenarios?
  - is your statistical model computationally feasible?
  - if the results of the power analysis require a large number of participants and/or trials, do you have enough time and/or resources?

# Preparation

In preparation for this meeting, you should have installed on your computer:

- [R](https://cran.r-project.org/)
- [Rstudio](https://rstudio.com/products/rstudio/download/)
- R packages:
  - [`here`](https://github.com/r-lib/here), which easily builds folder paths to load and save files
  - [`knitr`](https://github.com/yihui/knitr) and [`kableExtra`](https://github.com/haozhu233/kableExtra), to format the dynamically generated document
  - [`tidyverse`](https://github.com/tidyverse/tidyverse) and [`ggpubr`](https://github.com/kassambara/ggpubr), for data wrangling and plots
  - [`faux`](https://github.com/debruine/faux/), to simulate the data
  - [`broom.mixed`](https://github.com/bbolker/broom.mixed), for easier extraction of the results of the multilevel model

```{r install-load-pkgs, eval = FALSE}

### install packages
install.packages("here")
install.packages("knitr")
install.packages("kableExtra")
install.packages("tidyverse")
install.packages("faux")
install.packages("lme4")
install.packages("broom.mixed")
install.packages("ggpubr")

### load packages
library(here)
library(knitr)
library(kableExtra)
library(tidyverse)
library(faux)
library(lme4)
library(broom.mixed)
library(ggpubr)

```

Let's also create a custom `ggplot` theme for our graphs:

```{r ggplot-theme}

theme_custom <-
  theme_pubr(base_size = 16) + # base theme from package 'ggpubr'
  theme(
    strip.text = element_text(
      hjust = .5,
      size = 20
    ),
    plot.title = element_text(size = 26, hjust = .5),
    legend.box.background = element_rect(color = "transparent"),
    legend.position = "none"
  )

```

Last but not least, we need to set the seed for the random number generator. This is very important, because we want to be able to exactly reproduce the data we simulate.

```{r seed-rng, eval = FALSE}

seed_smorfia <- 17
set.seed(seed_smorfia)

```

Now that we have everything, let's start.


in this workshop we will be using the package `faux`, created by [Prof. Lisa DeBruine](https://www.gla.ac.uk/researchinstitutes/neurosciencepsychology/staff/lisadebruine/). Despite being quite recent, this package is actively maintained and well-documented, and its framework is user-friendly and adaptable to several popular study designs in the social sciences.


## Simulate data with crossed random factors

Until now we have generated, for each participant, mean values for each condition. However, in real life you typically present participants with a number of trials per condition and only later on you calculate the mean of these trial-level values. The `faux` package allows to simulate data with crossed random factors

### Data Simulation

`sim_mixed_cc` would not allow you to specify random slopes


From https://debruine.github.io/lmem_sim/articles/appendix1a_example_code.html





```{r MLM-params}

# parameters
MLM_n_ssj <- 50 # number of participants
# condition labels
MLM_cat_cond1 <- "ingroup"
MLM_cat_cond2 <- "outgroup"
# number of items for each condition
MLM_n_trials_cond1 <- 25
MLM_n_trials_cond2 <- 25
MLM_mu_grand <- 800 # grand mean [beta_0]
MLM_cond_beta <- 50 # effect of condition [beta_1]
MLM_item_sd <- 80 # by-item random intercept sd [omega_0]
MLM_ssj_sd <- 100 # by-subject random intercept sd [tau_0]
MLM_ssjslope_sd <- 40 # by-subject random slope sd [tau_1]
MLM_cor_int_slope <- .2 # correlation between intercept and slope [rho]
MLM_error_sd <- 200 # residual (standard deviation) [sigma]

```

```{r MLM-data-fun}

# custom data simulation function
MLM_data_fun <- function(
                         n_subj = MLM_n_ssj, # number of subjects
                         label_cond1 = MLM_cat_cond1, # label condition 1
                         label_cond2 = MLM_cat_cond2, # label condition 2
                         n_cond1 = MLM_n_trials_cond1, # number of stimuli condition 1
                         n_cond2 = MLM_n_trials_cond2, # number of stimuli condition 2
                         beta_0 = MLM_mu_grand, # grand mean
                         beta_1 = MLM_cond_beta, # effect of category
                         omega_0 = MLM_item_sd, # by-item random intercept sd
                         tau_0 = MLM_ssj_sd, # by-subject random intercept sd
                         tau_1 = MLM_ssjslope_sd, # by-subject random slope sd
                         rho = MLM_cor_int_slope, # correlation between intercept and slope
                         sigma = MLM_error_sd) { # residual (standard deviation)

  # simulate a sample of items
  items <- data.frame(
    item_id = seq_len(n_cond1 + n_cond2),
    condition = rep(c(label_cond1, label_cond2), c(n_cond1, n_cond2)),
    X_i = rep(c(-0.5, 0.5), c(n_cond1, n_cond2)),
    O_0i = rnorm(n = n_cond1 + n_cond2, mean = 0, sd = omega_0)
  )

  # simulate a sample of subjects
  subjects <- faux::rnorm_multi(
    n = n_subj, mu = 0, sd = c(tau_0, tau_1), r = rho,
    varnames = c("T_0s", "T_1s")
  )
  subjects$subj_id <- 1:n_subj

  # cross subject and item IDs
  crossing(subjects, items) %>%
    mutate(
      e_si = rnorm(nrow(.), mean = 0, sd = sigma),
      value = beta_0 + T_0s + O_0i + (beta_1 + T_1s) * X_i + e_si
    ) %>%
    select(subj_id, item_id, condition, X_i, value) %>%
    arrange(subj_id)
}

```

```{r MLM-data}

MLM_data <- MLM_data_fun()

# save as .csv
write_csv(
  MLM_data,
  here("data/MLM_data.csv")
)

# show first 10 rows
MLM_data %>%
  head(n = 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

### Statistical Analysis

```{r MLM-test}

# fit a linear mixed-effects model to data
MLM_results <- lmer(value ~ 1 + X_i + (1 | item_id) + (1 + X_i | subj_id),
  data = MLM_data
)

tibble(
  variable = c(
    "beta_0",
    "beta_1",
    "tau_0",
    "rho",
    "tau_1",
    "omega_0",
    "sigma"
  ),
  explanation = c(
    "intercept (grand mean)",
    "fixed effect of category",
    "by-item random intercept SD",
    "by-subject random intercept SD",
    "correlation between intercept and slope",
    "by-subject random slope SD",
    "residual (error) SD"
  ),
  `simulated value` = c(
    MLM_mu_grand,
    MLM_cond_beta,
    MLM_item_sd,
    MLM_ssj_sd,
    MLM_cor_int_slope,
    MLM_ssjslope_sd,
    MLM_error_sd
  ),
  `estimated by model` = broom.mixed::tidy(MLM_results)$estimate
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

### Graph

```{r MLM-plot}

MLM_plot <-
  ggviolin(
    MLM_data, # data
    x = "condition", # independent variable
    y = "value", # dependent variable
    color = "condition", # density: line color
    size = 1, # density: line width
    fill = "condition", # density: fill color
    alpha = .5, # density: fill color transparency
    linetype = "solid", # density: line type
    palette = c("#00AFBB", "#E7B800"), # density: color palette
    trim = TRUE, # density: trim tails
    width = 1, # density: violin width
    add = c("boxplot", "jitter"), # overlay boxplot and jittered individual data points
    add.params = list(
      color = "black", # boxplot and jittered points: color
      fill = "white",# boxplot and jittered points: fill color
      alpha = .2# boxplot and jittered points: fill transparency
    ),
    title = "Multilevel Model", # plot title
    label.rectangle = TRUE, # rectangle underneath text
    ggtheme = theme_custom # ggplot theme
  )

ggsave(
  filename = "MLM_plot.png",
  plot = MLM_plot,
  device = "png",
  path = here("figures"),
  width = 8,
  height = 8,
  units = "in",
  dpi = 300
)

MLM_plot

```

# Generate data from existing dataset





# Limitations

`faux` only generates samples from normal distributions
better solution: `synthpop`




# Other simulation packages

https://debruine.github.io/faux/index.html

I started this project as a collection of functions I was writing to help with my own work. It’s one of many, many simulation packages in R; here are some others. I haven’t used most of them, so I can’t vouch for them, but if faux doesn’t meet your needs, one of these might.

- simstudy: Simulation of Study Data
- simr: Power Analysis of Generalised Linear Mixed Models by Simulation
- simulator: streamlines the process of performing simulations by creating a common infrastructure that can be easily used and reused across projects
- lsasim: Simulate large scale assessment data
- simmer: Trajectory-based Discrete-Event Simulation (DES)
- parSim: Parallel Simulation Studies







# Session Info

```{r session-info}

sessionInfo()

```

***
***

[^1]: Adapted from the book [**Answering questions with data**](https://crumplab.github.io/statistics/index.html) (Chapter [11](https://crumplab.github.io/statistics/simulating-data.html#reasons-to-simulate)) by Matthew J. C. Crump.
[^2]: I recommend exploring the function `get_summary_stats` from package `rstatix`, especially the argument `type`... it's very comprehensive.
